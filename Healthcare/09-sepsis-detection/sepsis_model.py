"""
Early Sepsis Detection
Predicts sepsis 6 hours before onset using time-series clinical data
"""

import numpy as np
import pandas as pd
from sklearn.preprocessing import StandardScaler
from sklearn.ensemble import GradientBoostingClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import (
    roc_auc_score, precision_score, recall_score, f1_score, confusion_matrix
)
import joblib
import os

class SepsisDetector:
    \"\"\"\n    Detects early sepsis from time-series clinical data\n    \"\"\"\n    \n    def __init__(self):\n        self.model = None\n        self.scaler = StandardScaler()\n        self.feature_names = None\n        self.feature_importance = None\n        \n    def generate_sepsis_data(self, n_samples=1000, sepsis_rate=0.15, random_state=42):\n        \"\"\"Generate synthetic sepsis data\"\"\"\n        np.random.seed(random_state)\n        \n        data = {\n            # Vital signs - baseline\n            'heart_rate_baseline': np.random.uniform(60, 100, n_samples),\n            'respiratory_rate_baseline': np.random.uniform(12, 20, n_samples),\n            'temperature_baseline': np.random.uniform(36.5, 37.5, n_samples),\n            'systolic_bp_baseline': np.random.uniform(100, 140, n_samples),\n            'diastolic_bp_baseline': np.random.uniform(60, 90, n_samples),\n            'oxygen_saturation_baseline': np.random.uniform(95, 100, n_samples),\n            \n            # Vital signs - current (6 hours)\n            'heart_rate_current': np.random.uniform(50, 130, n_samples),\n            'respiratory_rate_current': np.random.uniform(10, 35, n_samples),\n            'temperature_current': np.random.uniform(35, 40, n_samples),\n            'systolic_bp_current': np.random.uniform(80, 160, n_samples),\n            'diastolic_bp_current': np.random.uniform(40, 110, n_samples),\n            'oxygen_saturation_current': np.random.uniform(85, 100, n_samples),\n            \n            # Blood work\n            'wbc_count': np.random.uniform(2, 30, n_samples),\n            'hemoglobin': np.random.uniform(7, 16, n_samples),\n            'platelet_count': np.random.uniform(50, 400, n_samples),\n            'glucose': np.random.uniform(50, 400, n_samples),\n            'lactate': np.random.exponential(2, n_samples),\n            'creatinine': np.random.exponential(1.5, n_samples),\n            'bilirubin': np.random.exponential(1, n_samples),\n            'procalcitonin': np.random.exponential(0.5, n_samples),\n            \n            # Blood gas\n            'ph': np.random.uniform(7.0, 7.5, n_samples),\n            'pco2': np.random.uniform(25, 60, n_samples),\n            'po2': np.random.uniform(50, 150, n_samples),\n            'bicarbonate': np.random.uniform(15, 30, n_samples),\n            \n            # Coagulation\n            'inr': np.random.uniform(0.8, 5, n_samples),\n            'pt': np.random.uniform(11, 50, n_samples),\n            'aptt': np.random.uniform(25, 80, n_samples),\n            \n            # Clinical factors\n            'age': np.random.uniform(18, 90, n_samples),\n            'immunocompromised': np.random.binomial(1, 0.2, n_samples),\n            'recent_surgery': np.random.binomial(1, 0.3, n_samples),\n            'central_line': np.random.binomial(1, 0.4, n_samples),\n            'mechanical_ventilation': np.random.binomial(1, 0.3, n_samples),\n            'catheter': np.random.binomial(1, 0.5, n_samples),\n            'recent_antibiotics': np.random.binomial(1, 0.4, n_samples),\n        }\n        \n        df = pd.DataFrame(data)\n        \n        # Calculate vital sign changes\n        df['hr_change'] = df['heart_rate_current'] - df['heart_rate_baseline']\n        df['rr_change'] = df['respiratory_rate_current'] - df['respiratory_rate_baseline']\n        df['temp_change'] = df['temperature_current'] - df['temperature_baseline']\n        df['sbp_change'] = df['systolic_bp_current'] - df['systolic_bp_baseline']\n        df['o2_change'] = df['oxygen_saturation_current'] - df['oxygen_saturation_baseline']\n        \n        # Generate sepsis indicator\n        sepsis_probability = (\n            (abs(df['temp_change']) > 1) * 0.15 +\n            (abs(df['hr_change']) > 20) * 0.15 +\n            (abs(df['rr_change']) > 5) * 0.15 +\n            (df['lactate'] > 2) * 0.15 +\n            (df['procalcitonin'] > 0.5) * 0.15 +\n            (df['wbc_count'] > 12 or df['wbc_count'] < 4) * 0.1 +\n            (df['platelet_count'] < 100) * 0.1 +\n            (df['ph'] < 7.3) * 0.1 +\n            (df['age'] > 65) * 0.05 +\n            (df['immunocompromised'] == 1) * 0.05\n        )\n        \n        sepsis_probability = np.clip(sepsis_probability, 0, 1)\n        df['sepsis'] = (np.random.random(n_samples) < sepsis_probability).astype(int)\n        \n        return df\n    \n    def train(self, df, test_size=0.2, random_state=42):\n        \"\"\"Train sepsis detection model\"\"\"\n        print(\"Training Early Sepsis Detection Model...\")\n        \n        # Feature selection\n        feature_cols = [\n            'heart_rate_baseline', 'respiratory_rate_baseline', 'temperature_baseline',\n            'systolic_bp_baseline', 'diastolic_bp_baseline', 'oxygen_saturation_baseline',\n            'heart_rate_current', 'respiratory_rate_current', 'temperature_current',\n            'systolic_bp_current', 'diastolic_bp_current', 'oxygen_saturation_current',\n            'wbc_count', 'hemoglobin', 'platelet_count', 'glucose', 'lactate',\n            'creatinine', 'bilirubin', 'procalcitonin', 'ph', 'pco2', 'po2',\n            'bicarbonate', 'inr', 'pt', 'aptt', 'age', 'immunocompromised',\n            'recent_surgery', 'central_line', 'mechanical_ventilation', 'catheter',\n            'recent_antibiotics', 'hr_change', 'rr_change', 'temp_change',\n            'sbp_change', 'o2_change'\n        ]\n        \n        self.feature_names = feature_cols\n        \n        X = df[feature_cols]\n        y = df['sepsis']\n        \n        # Split data\n        X_train, X_test, y_train, y_test = train_test_split(\n            X, y, test_size=test_size, random_state=random_state, stratify=y\n        )\n        \n        # Scale features\n        X_train_scaled = self.scaler.fit_transform(X_train)\n        X_test_scaled = self.scaler.transform(X_test)\n        \n        # Train model\n        print(\"  - Training Gradient Boosting Classifier...\")\n        self.model = GradientBoostingClassifier(\n            n_estimators=100,\n            learning_rate=0.1,\n            max_depth=5,\n            random_state=random_state\n        )\n        self.model.fit(X_train_scaled, y_train)\n        \n        # Feature importance\n        self.feature_importance = pd.DataFrame({\n            'feature': self.feature_names,\n            'importance': self.model.feature_importances_\n        }).sort_values('importance', ascending=False)\n        \n        # Evaluate\n        y_pred = self.model.predict(X_test_scaled)\n        y_pred_proba = self.model.predict_proba(X_test_scaled)[:, 1]\n        \n        metrics = {\n            'roc_auc': roc_auc_score(y_test, y_pred_proba),\n            'precision': precision_score(y_test, y_pred),\n            'recall': recall_score(y_test, y_pred),\n            'f1': f1_score(y_test, y_pred),\n            'confusion_matrix': confusion_matrix(y_test, y_pred)\n        }\n        \n        print(f\"    ROC-AUC: {metrics['roc_auc']:.4f}\")\n        print(f\"    Precision: {metrics['precision']:.4f}\")\n        print(f\"    Recall: {metrics['recall']:.4f}\")\n        print(f\"    F1-Score: {metrics['f1']:.4f}\")\n        \n        print(\"\\n  - Top 10 Sepsis Indicators:\")\n        for idx, row in self.feature_importance.head(10).iterrows():\n            print(f\"    {row['feature']}: {row['importance']:.4f}\")\n        \n        return metrics\n    \n    def predict_sepsis_risk(self, features_df):\n        \"\"\"Predict sepsis risk\"\"\"\n        X = features_df[self.feature_names]\n        X_scaled = self.scaler.transform(X)\n        \n        sepsis_probability = self.model.predict_proba(X_scaled)[:, 1]\n        sepsis_class = self.model.predict(X_scaled)\n        \n        return sepsis_probability, sepsis_class\n    \n    def save_model(self, model_path='models'):\n        \"\"\"Save model\"\"\"\n        os.makedirs(model_path, exist_ok=True)\n        joblib.dump(self.model, f'{model_path}/sepsis_model.pkl')\n        joblib.dump(self.scaler, f'{model_path}/scaler.pkl')\n        self.feature_importance.to_csv(f'{model_path}/feature_importance.csv', index=False)\n        print(f\"✓ Model saved to {model_path}/\")\n    \n    def load_model(self, model_path='models'):\n        \"\"\"Load model\"\"\"\n        self.model = joblib.load(f'{model_path}/sepsis_model.pkl')\n        self.scaler = joblib.load(f'{model_path}/scaler.pkl')\n        self.feature_importance = pd.read_csv(f'{model_path}/feature_importance.csv')\n        print(f\"✓ Model loaded from {model_path}/\")\n\ndef main():\n    print(\"=\" * 60)\n    print(\"EARLY SEPSIS DETECTION\")\n    print(\"=\" * 60)\n    \n    # Generate data\n    detector = SepsisDetector()\n    df = detector.generate_sepsis_data(n_samples=1000, sepsis_rate=0.15)\n    \n    # Train model\n    print(\"\\n1. Training model...\")\n    metrics = detector.train(df)\n    \n    # Save model\n    print(\"\\n2. Saving model...\")\n    detector.save_model()\n    \n    print(\"\\n✓ Early Sepsis Detection training completed successfully!\")\n\nif __name__ == '__main__':\n    main()\n
