"""
Hospital Readmission Prediction (Diabetes)
Predicts 30-day readmissions using EHR data and feature engineering
"""

import numpy as np
import pandas as pd
from sklearn.preprocessing import StandardScaler, LabelEncoder
from sklearn.ensemble import GradientBoostingClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import (
    roc_auc_score, precision_score, recall_score, f1_score, confusion_matrix
)
import joblib
import os

class ReadmissionPredictor:
    \"\"\"\n    Predicts 30-day hospital readmission for diabetic patients\n    \"\"\"\n    \n    def __init__(self):\n        self.model = None\n        self.scaler = StandardScaler()\n        self.label_encoders = {}\n        self.feature_names = None\n        self.feature_importance = None\n        \n    def generate_readmission_data(self, n_samples=1000, readmission_rate=0.25, random_state=42):\n        \"\"\"Generate synthetic readmission data\"\"\"\n        np.random.seed(random_state)\n        \n        data = {\n            # Demographics\n            'age': np.random.uniform(18, 90, n_samples),\n            'gender': np.random.choice(['M', 'F'], n_samples),\n            'race': np.random.choice(['Caucasian', 'African American', 'Hispanic', 'Other'], n_samples),\n            \n            # Admission information\n            'admission_type': np.random.choice(['Emergency', 'Urgent', 'Elective'], n_samples, p=[0.5, 0.3, 0.2]),\n            'admission_source': np.random.choice(['ER', 'Clinic', 'Physician Referral', 'Transfer'], n_samples),\n            'length_of_stay_days': np.random.exponential(5, n_samples),\n            'discharge_disposition': np.random.choice(['Home', 'SNF', 'ICF', 'Other'], n_samples),\n            \n            # Diabetes-related\n            'diabetes_type': np.random.choice(['Type 1', 'Type 2', 'Other'], n_samples, p=[0.1, 0.8, 0.1]),\n            'hba1c_level': np.random.uniform(5, 15, n_samples),\n            'glucose_level': np.random.uniform(70, 400, n_samples),\n            'insulin_used': np.random.binomial(1, 0.6, n_samples),\n            'diabetes_medications': np.random.poisson(2, n_samples),\n            \n            # Comorbidities\n            'hypertension': np.random.binomial(1, 0.5, n_samples),\n            'heart_disease': np.random.binomial(1, 0.3, n_samples),\n            'kidney_disease': np.random.binomial(1, 0.2, n_samples),\n            'copd': np.random.binomial(1, 0.15, n_samples),\n            'obesity': np.random.binomial(1, 0.4, n_samples),\n            'charlson_index': np.random.poisson(2, n_samples),\n            \n            # Clinical measurements\n            'systolic_bp': np.random.uniform(90, 180, n_samples),\n            'diastolic_bp': np.random.uniform(50, 120, n_samples),\n            'heart_rate': np.random.uniform(40, 120, n_samples),\n            'bmi': np.random.uniform(15, 50, n_samples),\n            'creatinine': np.random.exponential(1.2, n_samples),\n            'hemoglobin': np.random.uniform(7, 15, n_samples),\n            \n            # Medications\n            'num_medications': np.random.poisson(8, n_samples),\n            'num_changes_medications': np.random.poisson(2, n_samples),\n            'ace_inhibitor': np.random.binomial(1, 0.4, n_samples),\n            'beta_blocker': np.random.binomial(1, 0.3, n_samples),\n            'diuretic': np.random.binomial(1, 0.2, n_samples),\n            \n            # Healthcare utilization\n            'outpatient_visits_1yr': np.random.poisson(5, n_samples),\n            'inpatient_visits_1yr': np.random.poisson(2, n_samples),\n            'emergency_visits_1yr': np.random.poisson(3, n_samples),\n            'prior_readmissions_1yr': np.random.poisson(1, n_samples),\n            \n            # Social factors\n            'lives_alone': np.random.binomial(1, 0.3, n_samples),\n            'has_caregiver': np.random.binomial(1, 0.4, n_samples),\n            'insurance_type': np.random.choice(['Medicare', 'Medicaid', 'Private', 'Uninsured'], n_samples),\n        }\n        \n        df = pd.DataFrame(data)\n        \n        # Encode categorical\n        df['gender_encoded'] = pd.factorize(df['gender'])[0]\n        df['race_encoded'] = pd.factorize(df['race'])[0]\n        df['admission_type_encoded'] = pd.factorize(df['admission_type'])[0]\n        df['admission_source_encoded'] = pd.factorize(df['admission_source'])[0]\n        df['discharge_disposition_encoded'] = pd.factorize(df['discharge_disposition'])[0]\n        df['diabetes_type_encoded'] = pd.factorize(df['diabetes_type'])[0]\n        df['insurance_type_encoded'] = pd.factorize(df['insurance_type'])[0]\n        \n        # Generate readmission\n        readmission_probability = (\n            (df['age'] / 100) * 0.1 +\n            (df['charlson_index'] / 10) * 0.2 +\n            (df['hba1c_level'] / 15) * 0.15 +\n            (df['num_medications'] / 20) * 0.1 +\n            (df['prior_readmissions_1yr'] / 5) * 0.2 +\n            (df['admission_type_encoded'] == 0) * 0.1 +  # Emergency\n            (df['length_of_stay_days'] / 20) * 0.05 +\n            (1 - df['has_caregiver']) * 0.1\n        )\n        \n        readmission_probability = np.clip(readmission_probability, 0, 1)\n        df['readmitted'] = (np.random.random(n_samples) < readmission_probability).astype(int)\n        \n        return df\n    \n    def train(self, df, test_size=0.2, random_state=42):\n        \"\"\"Train readmission prediction model\"\"\"\n        print(\"Training Hospital Readmission Prediction Model...\")\n        \n        # Feature engineering\n        feature_cols = [\n            'age', 'gender_encoded', 'race_encoded', 'admission_type_encoded',\n            'admission_source_encoded', 'length_of_stay_days', 'discharge_disposition_encoded',\n            'diabetes_type_encoded', 'hba1c_level', 'glucose_level', 'insulin_used',\n            'diabetes_medications', 'hypertension', 'heart_disease', 'kidney_disease',\n            'copd', 'obesity', 'charlson_index', 'systolic_bp', 'diastolic_bp',\n            'heart_rate', 'bmi', 'creatinine', 'hemoglobin', 'num_medications',\n            'num_changes_medications', 'ace_inhibitor', 'beta_blocker', 'diuretic',\n            'outpatient_visits_1yr', 'inpatient_visits_1yr', 'emergency_visits_1yr',\n            'prior_readmissions_1yr', 'lives_alone', 'has_caregiver', 'insurance_type_encoded'\n        ]\n        \n        self.feature_names = feature_cols\n        \n        X = df[feature_cols]\n        y = df['readmitted']\n        \n        # Split data\n        X_train, X_test, y_train, y_test = train_test_split(\n            X, y, test_size=test_size, random_state=random_state, stratify=y\n        )\n        \n        # Scale features\n        X_train_scaled = self.scaler.fit_transform(X_train)\n        X_test_scaled = self.scaler.transform(X_test)\n        \n        # Train model\n        print(\"  - Training Gradient Boosting Classifier...\")\n        self.model = GradientBoostingClassifier(\n            n_estimators=100,\n            learning_rate=0.1,\n            max_depth=5,\n            random_state=random_state\n        )\n        self.model.fit(X_train_scaled, y_train)\n        \n        # Feature importance\n        self.feature_importance = pd.DataFrame({\n            'feature': self.feature_names,\n            'importance': self.model.feature_importances_\n        }).sort_values('importance', ascending=False)\n        \n        # Evaluate\n        y_pred = self.model.predict(X_test_scaled)\n        y_pred_proba = self.model.predict_proba(X_test_scaled)[:, 1]\n        \n        metrics = {\n            'roc_auc': roc_auc_score(y_test, y_pred_proba),\n            'precision': precision_score(y_test, y_pred),\n            'recall': recall_score(y_test, y_pred),\n            'f1': f1_score(y_test, y_pred),\n            'confusion_matrix': confusion_matrix(y_test, y_pred)\n        }\n        \n        print(f\"    ROC-AUC: {metrics['roc_auc']:.4f}\")\n        print(f\"    Precision: {metrics['precision']:.4f}\")\n        print(f\"    Recall: {metrics['recall']:.4f}\")\n        print(f\"    F1-Score: {metrics['f1']:.4f}\")\n        \n        print(\"\\n  - Top 10 Readmission Risk Factors:\")\n        for idx, row in self.feature_importance.head(10).iterrows():\n            print(f\"    {row['feature']}: {row['importance']:.4f}\")\n        \n        return metrics\n    \n    def predict_readmission_risk(self, features_df):\n        \"\"\"Predict readmission risk\"\"\"\n        X = features_df[self.feature_names]\n        X_scaled = self.scaler.transform(X)\n        \n        readmission_probability = self.model.predict_proba(X_scaled)[:, 1]\n        readmission_class = self.model.predict(X_scaled)\n        \n        return readmission_probability, readmission_class\n    \n    def save_model(self, model_path='models'):\n        \"\"\"Save model\"\"\"\n        os.makedirs(model_path, exist_ok=True)\n        joblib.dump(self.model, f'{model_path}/readmission_model.pkl')\n        joblib.dump(self.scaler, f'{model_path}/scaler.pkl')\n        self.feature_importance.to_csv(f'{model_path}/feature_importance.csv', index=False)\n        print(f\"✓ Model saved to {model_path}/\")\n    \n    def load_model(self, model_path='models'):\n        \"\"\"Load model\"\"\"\n        self.model = joblib.load(f'{model_path}/readmission_model.pkl')\n        self.scaler = joblib.load(f'{model_path}/scaler.pkl')\n        self.feature_importance = pd.read_csv(f'{model_path}/feature_importance.csv')\n        print(f\"✓ Model loaded from {model_path}/\")\n\ndef main():\n    print(\"=\" * 60)\n    print(\"HOSPITAL READMISSION PREDICTION\")\n    print(\"=\" * 60)\n    \n    # Generate data\n    predictor = ReadmissionPredictor()\n    df = predictor.generate_readmission_data(n_samples=1000, readmission_rate=0.25)\n    \n    # Train model\n    print(\"\\n1. Training model...\")\n    metrics = predictor.train(df)\n    \n    # Save model\n    print(\"\\n2. Saving model...\")\n    predictor.save_model()\n    \n    print(\"\\n✓ Hospital Readmission Prediction training completed successfully!\")\n\nif __name__ == '__main__':\n    main()\n
