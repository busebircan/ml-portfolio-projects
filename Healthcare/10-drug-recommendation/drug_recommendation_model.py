"""
Drug Recommendation System
Recommends medications based on patient history and conditions
"""

import numpy as np
import pandas as pd
from sklearn.preprocessing import StandardScaler, MultiLabelBinarizer
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import hamming_loss, accuracy_score
import joblib
import os

class DrugRecommender:
    \"\"\"\n    Recommends medications based on patient conditions and history\n    \"\"\"\n    \n    def __init__(self):\n        self.models = {}  # One model per drug\n        self.scaler = StandardScaler()\n        self.feature_names = None\n        self.drug_list = None\n        \n    def generate_drug_recommendation_data(self, n_samples=1000, random_state=42):\n        \"\"\"Generate synthetic drug recommendation data\"\"\"\n        np.random.seed(random_state)\n        \n        # Define drug list\n        self.drug_list = [\n            'Metformin', 'Lisinopril', 'Atorvastatin', 'Amlodipine',\n            'Omeprazole', 'Albuterol', 'Levothyroxine', 'Aspirin',\n            'Ibuprofen', 'Sertraline', 'Amoxicillin', 'Insulin'\n        ]\n        \n        data = {\n            # Demographics\n            'age': np.random.uniform(18, 90, n_samples),\n            'gender': np.random.choice([0, 1], n_samples),  # 0=M, 1=F\n            'weight_kg': np.random.uniform(50, 150, n_samples),\n            'height_cm': np.random.uniform(150, 200, n_samples),\n            \n            # Conditions\n            'diabetes': np.random.binomial(1, 0.3, n_samples),\n            'hypertension': np.random.binomial(1, 0.4, n_samples),\n            'heart_disease': np.random.binomial(1, 0.2, n_samples),\n            'asthma': np.random.binomial(1, 0.1, n_samples),\n            'copd': np.random.binomial(1, 0.08, n_samples),\n            'thyroid_disease': np.random.binomial(1, 0.05, n_samples),\n            'gerd': np.random.binomial(1, 0.15, n_samples),\n            'depression': np.random.binomial(1, 0.1, n_samples),\n            'arthritis': np.random.binomial(1, 0.12, n_samples),\n            'kidney_disease': np.random.binomial(1, 0.08, n_samples),\n            \n            # Lab values\n            'glucose_fasting': np.random.uniform(70, 300, n_samples),\n            'hba1c': np.random.uniform(5, 14, n_samples),\n            'ldl_cholesterol': np.random.uniform(50, 250, n_samples),\n            'hdl_cholesterol': np.random.uniform(20, 100, n_samples),\n            'triglycerides': np.random.uniform(50, 400, n_samples),\n            'systolic_bp': np.random.uniform(90, 180, n_samples),\n            'diastolic_bp': np.random.uniform(50, 120, n_samples),\n            'tsh': np.random.exponential(2, n_samples),\n            'creatinine': np.random.exponential(1.2, n_samples),\n            \n            # Allergies and contraindications\n            'penicillin_allergy': np.random.binomial(1, 0.05, n_samples),\n            'nsaid_contraindication': np.random.binomial(1, 0.1, n_samples),\n            'ace_inhibitor_contraindication': np.random.binomial(1, 0.05, n_samples),\n            \n            # Current medications\n            'num_current_medications': np.random.poisson(3, n_samples),\n            \n            # Adherence and history\n            'medication_adherence': np.random.uniform(0, 1, n_samples),\n            'prior_adverse_events': np.random.poisson(0.5, n_samples),\n        }\n        \n        df = pd.DataFrame(data)\n        \n        # Calculate BMI\n        df['bmi'] = df['weight_kg'] / ((df['height_cm'] / 100) ** 2)\n        \n        # Generate drug recommendations\n        recommendations = []\n        for idx, row in df.iterrows():\n            drugs = []\n            \n            # Diabetes medications\n            if row['diabetes'] and row['glucose_fasting'] > 126:\n                drugs.append('Metformin')\n                if row['hba1c'] > 8:\n                    drugs.append('Insulin')\n            \n            # Hypertension medications\n            if row['hypertension'] and row['systolic_bp'] > 140:\n                if not row['ace_inhibitor_contraindication']:\n                    drugs.append('Lisinopril')\n                drugs.append('Amlodipine')\n            \n            # Cholesterol medications\n            if row['ldl_cholesterol'] > 130 or row['heart_disease']:\n                drugs.append('Atorvastatin')\n            \n            # Aspirin for heart disease\n            if row['heart_disease']:\n                drugs.append('Aspirin')\n            \n            # GI medications\n            if row['gerd']:\n                drugs.append('Omeprazole')\n            \n            # Respiratory medications\n            if row['asthma'] or row['copd']:\n                drugs.append('Albuterol')\n            \n            # Thyroid medications\n            if row['thyroid_disease'] or row['tsh'] > 4:\n                drugs.append('Levothyroxine')\n            \n            # Mental health medications\n            if row['depression']:\n                drugs.append('Sertraline')\n            \n            # Pain management\n            if row['arthritis']:\n                if not row['nsaid_contraindication']:\n                    drugs.append('Ibuprofen')\n            \n            # Add some randomness\n            if np.random.random() < 0.1:\n                drugs.append(np.random.choice(self.drug_list))\n            \n            recommendations.append(list(set(drugs)))  # Remove duplicates\n        \n        df['recommended_drugs'] = recommendations\n        \n        return df\n    \n    def train(self, df, test_size=0.2, random_state=42):\n        \"\"\"Train drug recommendation models\"\"\"\n        print(\"Training Drug Recommendation System...\")\n        \n        # Feature selection\n        feature_cols = [\n            'age', 'gender', 'weight_kg', 'height_cm', 'bmi',\n            'diabetes', 'hypertension', 'heart_disease', 'asthma', 'copd',\n            'thyroid_disease', 'gerd', 'depression', 'arthritis', 'kidney_disease',\n            'glucose_fasting', 'hba1c', 'ldl_cholesterol', 'hdl_cholesterol',\n            'triglycerides', 'systolic_bp', 'diastolic_bp', 'tsh', 'creatinine',\n            'penicillin_allergy', 'nsaid_contraindication', 'ace_inhibitor_contraindication',\n            'num_current_medications', 'medication_adherence', 'prior_adverse_events'\n        ]\n        \n        self.feature_names = feature_cols\n        \n        X = df[feature_cols]\n        \n        # Split data\n        X_train, X_test = train_test_split(\n            X, test_size=test_size, random_state=random_state\n        )\n        \n        # Get corresponding recommendations\n        train_indices = X_train.index\n        test_indices = X_test.index\n        \n        # Scale features\n        X_train_scaled = self.scaler.fit_transform(X_train)\n        X_test_scaled = self.scaler.transform(X_test)\n        \n        # Train one model per drug\n        metrics_summary = {}\n        \n        for drug in self.drug_list:\n            print(f\"  - Training model for {drug}...\")\n            \n            # Create binary labels for this drug\n            y_train = np.array([drug in df.loc[idx, 'recommended_drugs'] for idx in train_indices])\n            y_test = np.array([drug in df.loc[idx, 'recommended_drugs'] for idx in test_indices])\n            \n            # Train model\n            model = RandomForestClassifier(\n                n_estimators=50,\n                max_depth=5,\n                random_state=random_state\n            )\n            model.fit(X_train_scaled, y_train)\n            \n            # Evaluate\n            y_pred = model.predict(X_test_scaled)\n            accuracy = accuracy_score(y_test, y_pred)\n            \n            self.models[drug] = model\n            metrics_summary[drug] = {'accuracy': accuracy}\n            \n            print(f\"    Accuracy: {accuracy:.4f}\")\n        \n        return metrics_summary\n    \n    def recommend_drugs(self, features_df, confidence_threshold=0.5):\n        \"\"\"Recommend drugs for patients\"\"\"\n        X = features_df[self.feature_names]\n        X_scaled = self.scaler.transform(X)\n        \n        recommendations = []\n        confidences = []\n        \n        for drug in self.drug_list:\n            model = self.models[drug]\n            proba = model.predict_proba(X_scaled)[:, 1]\n            recommendations.append(proba)\n        \n        # Transpose to get per-patient recommendations\n        recommendations = np.array(recommendations).T\n        \n        # Filter by confidence threshold\n        patient_recommendations = []\n        for rec in recommendations:\n            drugs = [self.drug_list[i] for i, conf in enumerate(rec) if conf >= confidence_threshold]\n            patient_recommendations.append(drugs)\n        \n        return patient_recommendations, recommendations\n    \n    def save_models(self, model_path='models'):\n        \"\"\"Save models\"\"\"\n        os.makedirs(model_path, exist_ok=True)\n        joblib.dump(self.models, f'{model_path}/drug_models.pkl')\n        joblib.dump(self.scaler, f'{model_path}/scaler.pkl')\n        joblib.dump(self.drug_list, f'{model_path}/drug_list.pkl')\n        print(f\"✓ Models saved to {model_path}/\")\n    \n    def load_models(self, model_path='models'):\n        \"\"\"Load models\"\"\"\n        self.models = joblib.load(f'{model_path}/drug_models.pkl')\n        self.scaler = joblib.load(f'{model_path}/scaler.pkl')\n        self.drug_list = joblib.load(f'{model_path}/drug_list.pkl')\n        print(f\"✓ Models loaded from {model_path}/\")\n\ndef main():\n    print(\"=\" * 60)\n    print(\"DRUG RECOMMENDATION SYSTEM\")\n    print(\"=\" * 60)\n    \n    # Generate data\n    recommender = DrugRecommender()\n    df = recommender.generate_drug_recommendation_data(n_samples=1000)\n    \n    # Train models\n    print(\"\\n1. Training models...\")\n    metrics = recommender.train(df)\n    \n    # Save models\n    print(\"\\n2. Saving models...\")\n    recommender.save_models()\n    \n    # Test recommendations\n    print(\"\\n3. Testing recommendations...\")\n    test_df = df.head(5)[recommender.feature_names]\n    recommendations, confidences = recommender.recommend_drugs(test_df, confidence_threshold=0.5)\n    \n    print(\"\\nSample Recommendations:\")\n    for i, rec in enumerate(recommendations):\n        print(f\"  Patient {i+1}: {', '.join(rec) if rec else 'No drugs recommended'}\")\n    \n    print(\"\\n✓ Drug Recommendation System training completed successfully!\")\n\nif __name__ == '__main__':\n    main()\n
